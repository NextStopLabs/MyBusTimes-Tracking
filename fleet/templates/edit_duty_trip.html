{% extends 'mbtbase.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style>
  .trip-group {
    margin-top: 15px;
    padding: 10px;
    border: 1px solid var(--border-color);
    border-radius: 0.5em;
    position: relative;
  }
  .trip-group label {
    display: block;
    margin-top: 5px;
  }
  .trip-group input, .trip-group select {
    width: 100%;
    padding: 5px;
    box-sizing: border-box;
  }
  .remove-trip {
    position: absolute;
    top: -6px;
    right: 0px;
    background: none;
    border: medium;
    color: rgb(204, 0, 0);
    font-size: 28px;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block title %}Edit Trips for {{ duty_instance.duty_name }}{% endblock %}

{% block content %}
  <h2>Edit Trips for Duty: {{ duty_instance.duty_name }}</h2>
  <form style="width: 50%;" action="{% url 'flip_all_duty_trip_directions' operator_slug=operator.operator_slug board_id=duty_instance.id %}" method="post">
    {% csrf_token %}
    <button class="btn">Flip all trip directions</button>
  </form><br>
  <form method="post" class="fleet-edit-wrapper">
    {% csrf_token %}
    <div>
      <label>Trips:</label>
      <button type="button" id="add-trip">Add Trip</button>
      <div id="trips-container">
        {% for trip in duty_instance.duty_trips.all %}
          <div class="trip-group">
            <button type="button" class="remove-trip" title="Remove Trip">&times;</button>

            <label>Select Route:</label>
            <select class="route-select">
              {% for r in available_routes %}
                <option value="{{ r.route_num }}" {% if r.route_num == trip.route %}selected{% endif %}>
                  {{ r.route_num }} - {{ r.route_inbound_destination }} to {{ r.route_outbound_destination }}
                </option>
              {% endfor %}
            </select>

            <label>Route Num</label>
            <input type="text" name="route_num[]" value="{{ trip.route }}" required>

            <label>Start Time:</label>
            <input type="time" name="start_time[]" value="{{ trip.start_time|time:'H:i' }}" required>

            <label>End Time:</label>
            <input type="time" name="end_time[]" value="{{ trip.end_time|time:'H:i' }}" required>

            <label>Start At:</label>
            <input type="text" name="start_at[]" value="{{ trip.start_at }}" required>

            <label>End At:</label>
            <input type="text" name="end_at[]" value="{{ trip.end_at }}" required>

            <label for="inbound">inbound?</label>
            <input type="hidden" name="inbound_trip[]" value="false">
            <input type="checkbox" name="inbound_trip_check[]" {% if trip.inbound %}checked{% endif %}>
          </div>
        {% endfor %}
      </div>
    </div>

    <button type="submit" style="margin-top: 20px;">Save Trips</button>
  </form>

  <!-- Select2 JS -->
  <script>
    function addCheckboxListeners() {
      document.querySelectorAll('input[type="checkbox"][name="inbound_trip_check[]"]').forEach(function(checkbox) {
        const hiddenInput = checkbox.previousElementSibling;
        if (hiddenInput && hiddenInput.name === 'inbound_trip[]') {
           hiddenInput.value = checkbox.checked ? 'true' : 'false';
           checkbox.onchange = function() {
             hiddenInput.value = this.checked ? 'true' : 'false';
           };
        }
      });
    }

    function addRemoveTripListeners() {
      document.querySelectorAll('.remove-trip').forEach(function(btn) {
        btn.onclick = function() {
          // Destroy select2 instance before removing to avoid memory leaks
          const select = btn.closest('.trip-group').querySelector('.route-select');
          if ($(select).hasClass('select2-hidden-accessible')) {
            $(select).select2('destroy');
          }
          btn.closest('.trip-group').remove();
        };
      });
    }

    function addRouteSelectListeners() {
      document.querySelectorAll('.route-select').forEach(function(select) {
        select.onchange = function() {
          const hiddenInput = this.parentElement.querySelector('input[name="route_num[]"]');
          hiddenInput.value = this.value;
        };
      });
    }

    function initSelect2() {
      $('.route-select').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
          $(this).select2({
            width: '100%',
            placeholder: "Select a route",
            allowClear: true,
            minimumResultsForSearch: 5  // show search if 5+ options
          });
        }
      });
    }

    // Initialize everything on page load
    document.addEventListener('DOMContentLoaded', function() {
      addRemoveTripListeners();
      addRouteSelectListeners();
      initSelect2();
      addCheckboxListeners();
    });

    document.getElementById('add-trip').addEventListener('click', function(e) {
      e.preventDefault();

      const container = document.getElementById('trips-container');
      const tripGroup = document.createElement('div');
      tripGroup.classList.add('trip-group');

      // Build options string for routes
      const routeOptions = `{% for r in available_routes %}<option value="{{ r.route_num }}">{{ r.route_num }} - {{ r.route_inbound_destination }} to {{ r.route_outbound_destination }}</option>{% endfor %}`;

      tripGroup.innerHTML = `
        <button type="button" class="remove-trip" title="Remove Trip">&times;</button>
        <label>Select Route:</label>
        <select class="route-select" required>
          ${routeOptions}
        </select>
        <input type="hidden" name="route_num[]" required>
        <label>Start Time:</label>
        <input type="time" name="start_time[]" required>
        <label>End Time:</label>
        <input type="time" name="end_time[]" required>
        <label>Start At:</label>
        <input type="text" name="start_at[]" required>
        <label>End At:</label>
        <input type="text" name="end_at[]" required>
        <label for="inbound">inbound?</label>
        <input type="hidden" name="inbound_trip[]" value="false">
        <input type="checkbox" name="inbound_trip_check[]">
      `;

      container.appendChild(tripGroup);

      // Initialize Select2 on the new select
      initSelect2();

      // Initialize hidden input with first option's value
      const newSelect = tripGroup.querySelector('.route-select');
      const newHiddenInput = tripGroup.querySelector('input[name="route_num[]"]');
      newHiddenInput.value = newSelect.value;

      addRemoveTripListeners();
      addRouteSelectListeners();
      addCheckboxListeners();
    });
  </script>
{% endblock %}
