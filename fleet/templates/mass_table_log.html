{% extends 'mbtbase.html' %}
{% load static %}

{% block title %}Mass Log Trips - {{ operator.operator_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
{% endblock %}


{% block content %}

<h2>Mass Log Trips - {{ operator.operator_name }}</h2>

    <!-- GLOBAL BOARD TYPE -->
    <div class="fleet-edit-wrapper">
        <label>Global Board Type:</label>
        <select id="global-board-type">
            <option value="">(none)</option>
            <option value="duty">Duty</option>
            <option value="running">Running Board</option>
        </select>
    </div>

    <form method="POST" id="assignForm">
        {% csrf_token %}

        <!-- DATE -->
        <div class="fleet-edit-wrapper">
            <label><strong>Select Date:</strong></label>
            <input type="date" name="date" id="assign-date" value="{{ current_date }}">
        </div><br>

        <!-- VEHICLE TABLE -->
        <div class="table-wrapper">
            <table class="fleet" border="0" cellpadding="10" cellspacing="0">
                <thead>
                    <tr>
                        <th>Vehicle</th>
                        <th>Board Type</th>
                        <th>Duty / Running Board</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in vehicles %}
                    <tr>

                        <td> 
                            {{ v.fleet_number }} - {{ v.reg }} - {{ v.vehicleType }}
                        </td>

                        <!-- TYPE -->
                        <td>
                            <select 
                                name="assignments[{{ v.id }}][board_type]"
                                class="board-type"
                                data-vehicle="{{ v.id }}"
                            >
                                <option value="">Select…</option>
                                <option value="duty">Duty</option>
                                <option value="running">Running Board</option>
                            </select>
                        </td>

                        <!-- BOARD -->
                        <td>
                            <select 
                                name="assignments[{{ v.id }}][board_id]"
                                class="board-id"
                                data-vehicle="{{ v.id }}"
                            >
                                <option value="">Select…</option>

                                {% for d in duties %}
                                <option value="{{ d.id }}" data-type="duty">
                                    Duty: {{ d.duty_name }}
                                </option>
                                {% endfor %}

                                {% for rb in running_boards %}
                                <option value="{{ rb.id }}" data-type="running">
                                    RB: {{ rb.duty_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;background: #000000b2;">
            <div style="max-width: 35em;margin: 0 auto;background: var(--background-color);margin-top: 25vh;padding: 1em;border-radius: 0.5em;">
                <button type="button" style="display: none; float: right; border-radius: 50%; height: 25px; width: 25px; text-align: center; padding: 1px 7px; margin-top: -25px; margin-right: -25px;" id="close-progress-btn">X</button>
                <label>Logging Progress:</label>
                <progress id="log-progress" value="0" max="100" style="width: 100%;"></progress>
                <span id="progress-text">0 / 0</span>
                <div id="log-status" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); padding: 5px; margin-top: 5px; border-radius: 0.5em; font-size: 0.9em;"></div>
            </div>
        </div>

        <button type="button" id="start-log-btn">Save Assignments</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // -------------------------------
    // Stable key generator
    // -------------------------------
    function getKey(el) {

        if (el.classList.contains("board-type"))
            return "massassign_vehicle_" + el.dataset.vehicle + "_type";

        if (el.classList.contains("board-id"))
            return "massassign_vehicle_" + el.dataset.vehicle + "_id";

        if (el.id === "global-board-type")
            return "massassign_global_type";

        if (el.id === "assign-date")
            return "massassign_date";

        return "massassign_" + el.id;
    }

    // -------------------------------
    // Load saved values
    // -------------------------------
    document.querySelectorAll(".board-type, .board-id, #assign-date, #global-board-type")
        .forEach(el => {
            const stored = localStorage.getItem(getKey(el));
            if (stored !== null) el.value = stored;
        });

    // -------------------------------
    // Save on change
    // -------------------------------
    function saveElement(el) {
        localStorage.setItem(getKey(el), el.value);
    }

    document.querySelectorAll(".board-type, .board-id, #assign-date, #global-board-type")
        .forEach(el => el.addEventListener("change", () => {
            saveElement(el);

            if (el.id === "global-board-type")
                applyGlobalBoardType();

            if (el.classList.contains("board-type"))
                filterBoards(el);
        }));

    // -------------------------------
    // Filter duty/running options
    // -------------------------------
    function filterBoards(typeSelect) {
        const vehicle = typeSelect.dataset.vehicle;
        const type = typeSelect.value;

        const boardSelect = document.querySelector(
            'select.board-id[data-vehicle="' + vehicle + '"]'
        );

        boardSelect.querySelectorAll("option").forEach(opt => {
            if (!opt.dataset.type) return;
            opt.hidden = (opt.dataset.type !== type);
        });

        // Reset invalid selection
        const selected = boardSelect.selectedOptions[0];
        if (selected && selected.dataset.type !== type) {
            boardSelect.value = "";
            saveElement(boardSelect);
        }
    }

    // -------------------------------
    // Apply global type
    // -------------------------------
    function applyGlobalBoardType() {
        const globalType = document.getElementById("global-board-type").value;

        document.querySelectorAll(".board-type").forEach(el => {

            // Only apply if blank OR if user selected a new global type
            if (!el.value || globalType !== localStorage.getItem(getKey(el))) {
                el.value = globalType;
                saveElement(el);
                filterBoards(el);
            }
        });
    }

    // -------------------------------
    // Initial load
    // -------------------------------
    applyGlobalBoardType();
    document.querySelectorAll(".board-type").forEach(el => filterBoards(el));

    // -----------------------------------------
    // Track used board IDs & hide from others
    // -----------------------------------------
    function updateUsedBoards() {
        const used = new Set();

        // Collect all selected board IDs
        document.querySelectorAll(".board-id").forEach(sel => {
            if (sel.value) used.add(sel.value);
        });

        // Apply hiding to all select boxes
        document.querySelectorAll(".board-id").forEach(sel => {
            sel.querySelectorAll("option").forEach(opt => {
                if (!opt.value) return;

                // If this vehicle has selected it → keep visible
                if (sel.value === opt.value) {
                    opt.hidden = false;
                    return;
                }

                // Hide if selected by another vehicle
                opt.hidden = used.has(opt.value);
            });
        });
    }

    // -------------------------------
    // Hook into every board-id change
    // -------------------------------
    document.querySelectorAll(".board-id").forEach(el =>
        el.addEventListener("change", () => {
            saveElement(el);
            updateUsedBoards();
        })
    );

    // -------------------------------
    // Run on first load
    // -------------------------------
    updateUsedBoards();

    // -------------------------------
    // Mass Logging Logic
    // -------------------------------
    const startBtn = document.getElementById("start-log-btn");
    const progressContainer = document.getElementById("progress-container");
    const progressBar = document.getElementById("log-progress");
    const progressText = document.getElementById("progress-text");
    const logStatus = document.getElementById("log-status");
    const dateInput = document.getElementById("assign-date");
    const closeProgressBtn = document.getElementById("close-progress-btn");

    startBtn.addEventListener("click", async () => {
        const date = dateInput.value;
        if (!date) {
            alert("Please select a date.");
            return;
        }

        // Collect assignments
        const assignments = [];
        document.querySelectorAll(".board-type").forEach(typeSelect => {
            const vehicleId = typeSelect.dataset.vehicle;
            const type = typeSelect.value;
            
            const boardSelect = document.querySelector(
                'select.board-id[data-vehicle="' + vehicleId + '"]'
            );
            const boardId = boardSelect.value;

            if (type && boardId) {
                assignments.push({
                    vehicle_id: vehicleId,
                    board_type: type,
                    board_id: boardId,
                    date: date
                });
            }
        });

        if (assignments.length === 0) {
            alert("No assignments to log.");
            return;
        }

        // UI Setup
        startBtn.disabled = true;
        progressContainer.style.display = "block";
        progressBar.max = assignments.length;
        progressBar.value = 0;
        logStatus.innerHTML = "";
        let completed = 0;
        let errors = 0;

        // Process
        for (const task of assignments) {
            const formData = new FormData();
            formData.append("vehicle_id", task.vehicle_id);
            formData.append("board_type", task.board_type);
            formData.append("board_id", task.board_id);
            formData.append("date", task.date);
            formData.append("csrfmiddlewaretoken", document.querySelector('[name=csrfmiddlewaretoken]').value);

            try {
                const response = await fetch("{% url 'mass_assign_single_vehicle_api' operator.operator_slug %}", {
                    method: "POST",
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    logStatus.innerHTML += `<div style="color: green;">✓ Vehicle ${task.vehicle_id}: ${result.message}</div>`;
                } else {
                    errors++;
                    logStatus.innerHTML += `<div style="color: red;">✗ Vehicle ${task.vehicle_id}: ${result.error}</div>`;
                }
            } catch (err) {
                errors++;
                logStatus.innerHTML += `<div style="color: red;">✗ Vehicle ${task.vehicle_id}: Network error</div>`;
            }

            completed++;
            progressBar.value = completed;
            progressText.innerText = `${completed} / ${assignments.length}`;
            logStatus.scrollTop = logStatus.scrollHeight;
        }

        startBtn.disabled = false;
        
        progressBar.accentColor = errors > 0 ? "red" : "green";
        progressText.innerText += errors > 0 ? ` - Completed with ${errors} errors.` : " - All completed successfully.";
        closeProgressBtn.style.display = "flex";

        closeProgressBtn.addEventListener("click", () => {
            progressContainer.style.display = "none";
            closeProgressBtn.style.display = "none";
        });
    });

});
</script>


{% endblock %}
