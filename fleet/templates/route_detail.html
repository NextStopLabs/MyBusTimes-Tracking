{% extends 'mbtbase.html' %}
{% load static %}
{% load custom_tags %}
{% load url_filters %}
{% load meta_tags %}

{% block extra_meta %}
    {% meta_description "{{ route.route_num }} {{ route.route_name }} {{ route.inbound_destination }} {{ route.outbound_destination }}" %}
    {% meta_keywords "vehicle, {{ vehicle.fleet_number }}, {{ vehicle.reg }}, {{ vehicle.operator.operator_name }}" %}
    {% meta_title "{{ route.route_num }} {{ route.route_name }} {{ route.inbound_destination }} {{ route.outbound_destination }}" %}
    {% meta_url "https://www.mybustimes.cc/operator/{{ operator.operator_slug }}/route/{{ route.id }}/" %}
{% endblock %}

{% block title %}{{ full_route_num }}{% endblock %}



{% block content %}

<style>
    .route {
        margin: 1em 0;
        padding: 0;
    }

    .route li::before {
        border: 3px solid var(--border-color);
        content: " ";
        border-width: 3px 0 0 3px;
        width: 6px;
        height: 1em;
        margin-top: .5em;
        display: block;
        position: absolute;
    }

    .route li:last-child::before {
        height: 0px;
    }

    .route .minor::before {
        border-top-width: 1px;
        width: 1em;
        height: calc(1em + 2px);
    }

    .route a {
        margin-left: 1em;
    }

    .route .minor a {
        margin-left: 2em;
        font-size: .875em;
    }

    .stop-operator {
    writing-mode: sideways-lr;
    }
</style>

{% if operator.operator_details.transit_authorities and transit_authority_details %}
<script>
    const style = document.createElement('style');
    style.textContent = `.name { 
      background: {{ transit_authority_details.primary_colour|default:"#000" }};
      color: {{ transit_authority_details.secondary_colour|default:"#fff" }};
      border-color: {{ transit_authority_details.secondary_colour|default:"#fff" }};
    }`;
    document.head.appendChild(style);
</script>
{% endif %}

<h1 class="service-header">
    {% if route.linked_route.all %}
    {% if route.route_num %}
    <strong class="name first is-short" style="{{ route.colours }}">
        {{ route.route_num }}
    </strong>
    {% endif %}
    {% for linked in route.linked_route.all %}
    {% if forloop.last %}
    <strong class="name last is-short" style="{{ route.colours }}">
        {{ linked.route_num }}
    </strong>
    {% else %}
    <strong class="name middle is-short">
        {{ linked.route_num }}
    </strong>
    {% endif %}
    {% endfor %}
    {% else %}
    {% if route.route_name %}
    <strong class="name is-short first" style="{{ route.colours }}">{{ route.route_num }}</strong>
    {% else %}
    {% if route.route_num %}
    <strong class="name is-short" style="{{ route.colours }}">{{ route.route_num }}</strong>
    {% endif %}
    {% endif %}
    {% endif %}

    {% if route.route_name %}
    {% if route.route_num %}
    <strong class="last name" style="margin: 0; font-size: 18px; {{ route.colours }}">
        {{ route.route_name }}
    </strong>
    {% else %}
    <strong class="name" style="margin: 0; font-size: 18px; {{ route.colours }}">
        {{ route.route_name }}
    </strong>
    {% endif %}
    {% endif %}
    <span class="destination">
        {{ route.inbound_destination }}
        {% if route.other_destination %}{% for dest in route.other_destination %} - {{ dest }}{% endfor %}{% endif %}
        {% if route.outbound_destination %} - {{ route.outbound_destination }}{% endif %}
    </span>
</h1>
{% if route.start_date and route.start_date > today and route.start_date != 'None' %}
    <p style="margin-top: -1em;">Starting {{ route.start_date }}</p>
{% endif %}
<p>
    A service operated by
    {% for operator in allOperators %}
    <a href="/operator/{{ operator.operator_slug|urlencode }}">{{ operator.operator_name }}</a>{% if not forloop.last %}{% if allOperators|length > 2 %}, {% else %} and {% endif %}{% endif %}
    {% endfor %}
</p>

{% if school_service == "true" %}
<p>üßë‚Äçüéì This is a closed-door school service</p>
{% endif %}

{% if hidden == True %}
<p>This service is <strong>not</strong> for general public use.</p>
{% endif %}

<ul class="horizontal">
    {% if 'Edit Routes' in helperPermsData or 'owner' in helperPermsData %}
    <li><a href="/operator/{{ operator.operator_slug|urlencode }}/route/{{ route.id }}/edit">Route Options</a></li>
    {% endif %}
    {% if 'Add Timetables' in helperPermsData or 'Edit Timetables' in helperPermsData or 'owner' in helperPermsData %}
    <li><a href="/operator/{{ operator.operator_slug|urlencode }}/route/{{ route.id }}/timetable/options">Timetable
            Options</a></li>
    {% endif %}
    {% if 'Add Route Updates' in helperPermsData or 'owner' in helperPermsData %}
    <li><a href="/operator/{{ operator.operator_slug|urlencode }}/route/{{ route.id }}/updates/options">Route Update
            Options</a></li>
    {% endif %}
    {% if 'owner' in helperPermsData %}
    <li><a href="/operator/{{ operator.operator_slug|urlencode }}/route/{{ route.id }}/status">Check Trackable Status</a></li>
    {% endif %}
    {% if user.is_superuser %}<a style="font-size: 14px;" href="/api-admin/routes/route/{{ route.id }}/change/">‚úé</a>{% endif %}
</ul>

{% if current_updates %}
<div class="service-updates">
    {% for update in current_updates %}
    <div class="service-update">
        <details>
            <summary>
                {{ update.update_title }}
                <div class="dates">
                    {{ update.start_date|date:"l j F" }} - {{ update.end_date|date:"l j F Y" }}
                </div>
            </summary>
            <p>{{ update.update_description }}</p>
            <p>Effected Routes:
                {% for eff_route in update.effected_route.all %}
                <a
                    href="/operator/{{ eff_route.route_operators.first.operator_slug|urlencode }}/route/{{ eff_route.id }}">{{ eff_route.route_num }}</a>{% if not forloop.last %},
                {% endif %}
                {% endfor %}
            </p>
        </details>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="in-page-ad" id="body-ad-1">
  <div class="incontent-ad-container" style="height:100px;">
    <div id="AFM_inContent_ad" style="margin:auto;"></div>
  </div>
</div>


<form id="route-form" method="GET">
    <!-- Route Selector -->
    {% if otherRoutes %}
    <select name="route-selector" id="route">
        <option value="{{ route.id }}" selected>
            {{ route.route_num }} - {{ route.inbound_destination }}{% if route.outbound_destination %} -
            {{ route.outbound_destination }}{% endif %}
        </option>
        {% for rel_route in otherRoutes %}
        <option value="{{ rel_route.id }}">
            {{ rel_route.route_num }} - {{ rel_route.inbound_destination }}{% if rel_route.outbound_destination %} -
            {{ rel_route.outbound_destination }}{% endif %}
        </option>
        {% endfor %}
    </select>
    {% else %}
    <input type="hidden" name="route-selector" id="route" value="{{ route.id }}">
    {% endif %}

    <!-- Day Selector -->
    {% if days %}
    <select id="day-selector" name="day">
        {% for day in days %}
        <option value="{{ day.id }}" {% if selectedDay == day %}selected{% endif %}>{{ day }}</option>
        {% endfor %}
    </select>
    {% else %}
    <input type="hidden" name="day-selector" id="day" value="{{ selectedDay|default:'0' }}">
    {% endif %}

    <!-- Submit Button -->
    {% if otherRoutes or days %}
    <input type="submit" value="Submit">
    {% endif %}
</form>
<br>
<script>
    document.getElementById('route-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const routeEl = document.getElementById('route');
        const dayEl = document.getElementById('day-selector') || document.getElementById('day');

        const selectedRoute = routeEl ? routeEl.value : '';
        const selectedDay = dayEl ? dayEl.value : '0';
        const operatorSlug = "{{ operator.operator_slug|escapejs }}";

        const finalUrl =
            `/operator/${operatorSlug}/route/${selectedRoute}?day=${encodeURIComponent(selectedDay)}`;
        window.location.href = finalUrl;
    });
</script>

<ul class="tabs">
    <li class="active">Timetable</li>
    <li class=""><a href="/map/route/{{ route.id }}/" id="mapBT">Map</a></li>
    <li class=""><a href="vehicles">Vehicles</a></li>
</ul>

<button onclick="printTable()" class="no-print">Print</button>
<br>

<div id="printable-area">
    <div class="timetable">
        {% if route.outbound_destination %}
        <h2>{{ route.inbound_destination }} - {{ route.outbound_destination }}{% if user.is_superuser %}{% if outbound_timetable.id %} ‚Ä¢ <a style="font-size: 14px;" href="/api-admin/routes/timetableentry/{{ outbound_timetable.id }}/change/">‚úé</a>{% else %} ‚Ä¢ <a style="font-size: 14px;" href="/api-admin/routes/routestop/{{ route_stops_full.outbound.id }}/change/">‚úé</a>{% endif %}{% endif %}</h2>
        <div class="stop-visibility">
            <input type="radio" name="stop-visibility-outbound" id="timing-point-outbound" checked>
            <label for="timing-point-outbound">Timing Points</label>

            <input type="radio" name="stop-visibility-outbound" id="all-stops-outbound">
            <label for="all-stops-outbound">All Stops</label>
        </div><br>

        {% if outbound_timetable.start_date and outbound_timetable.end_date %}
            <p>This timetable runs from, {{ outbound_timetable.start_date }}, until, {{ outbound_timetable.end_date }}</p>
            {% elif outbound_timetable.start_date %}
            <p>This timetable runs from, {{ outbound_timetable.start_date }}</p>
            {% elif outbound_timetable.end_date %}
            <p>This timetable runs until, {{ outbound_timetable.end_date }}</p>
        {% endif %}

        <div class="timetable" id="outbound-timetable">
            {% if outboundStops %}
            <table class="fleet" border="0" cellpadding="10" cellspacing="0">
                <tbody>
                    {% if outboundUniqueOperators|length > 1 %}
                    <tr class="stop-row">
                        <th class="stop-name operator-name" scope="row">Operator</th>
                        {% for group in outboundGroupedSchedule %}
                        <td style="border-top: 0;" class="stop-operator" colspan="{{ group.colspan }}">{{ group.name }}</td>
                        {% endfor %}
                    </tr>
                    {% endif %}

                    {% for idx, stop in outboundTimetableData.items %}
                    <tr id="{{ stop.stopname }}" class="stop-row {% if not stop.timing_point %}minor{% endif %}">
                        <th class="stop-name" scope="row">
                            <a href="/stop/?name={{ idx|urlquote }}">{{ stop.stopname }}</a>
                        </th>
                        {% for time in stop.times %}
                        <td class="stop-time col-{{ forloop.counter0 }}">
                            {{ time }}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% elif route_stops_full.outbound %}
            <ul class="route">
                {% for stop in route_stops_full.outbound.stops %}
                <li {% if not stop.timing_point %}class="minor" {% endif %}><a
                        href="/stop/?name={{ stop.stop|urlquote }}">{{ stop.stop }}</a></li>
                {% endfor %}
            </ul>
            {% else %}
            <p>No stop data</p>
            {% endif %}
        </div>
    </div>

    <div class="timetable">

        <h2>{{ route.outbound_destination }} - {{ route.inbound_destination }}{% if user.is_superuser %}{% if outbound_timetable.id %} ‚Ä¢ <a style="font-size: 14px;" href="/api-admin/routes/timetableentry/{{ inbound_timetable.id }}/change/">‚úé</a>{% else %} ‚Ä¢ <a style="font-size: 14px;" href="/api-admin/routes/routestop/{{ route_stops_full.inbound.id }}/change/">‚úé</a>{% endif %}{% endif %}</h2>
        <div class="stop-visibility">
            <input type="radio" name="stop-visibility-inbound" id="timing-point-inbound" checked>
            <label for="timing-point-inbound">Timing Points</label>

            <input type="radio" name="stop-visibility-inbound" id="all-stops-inbound">
            <label for="all-stops-inbound">All Stops</label>
        </div><br>

        {% if inbound_timetable.start_date and inbound_timetable.end_date %}
            <p>This timetable runs from, {{ inbound_timetable.start_date }}, until, {{ inbound_timetable.end_date }}</p>
            {% elif inbound_timetable.start_date %}
            <p>This timetable runs from, {{ inbound_timetable.start_date }}</p>
            {% elif inbound_timetable.end_date %}
            <p>This timetable runs until, {{ inbound_timetable.end_date }}</p>
        {% endif %}

        <div class="timetable" id="inbound-timetable">
            {% if inboundStops %}
            <table class="fleet" border="0" cellpadding="10" cellspacing="0">
                <tbody>
                    {% if inboundUniqueOperators|length > 1 %}
                    <tr class="stop-row">
                        <th class="stop-name operator-name" scope="row">Operator</th>
                        {% for group in inboundGroupedSchedule %}
                        <td style="border-top: 0;" class="stop-operator" colspan="{{ group.colspan }}">{{ group.name }}</td>
                        {% endfor %}
                    </tr>
                    {% endif %}

                    {% for idx, stop in inboundTimetableData.items %}
                    <tr id="{{ stop.stopname }}" class="stop-row {% if not stop.timing_point %}minor{% endif %}">
                        <th class="stop-name" scope="row">
                            <a href="/stop/?name={{ idx|urlquote }}">{{ stop.stopname }}</a>
                        </th>
                        {% for time in stop.times %}
                        <td class="stop-time col-{{ forloop.counter0 }}">
                            {{ time }}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% elif route_stops_full.inbound %}
            <ul class="route">
                {% for stop in route_stops_full.inbound.stops %}
                <li {% if not stop.timing_point %}class="minor" {% endif %}><a
                        href="/stop/?name={{ stop.stop|urlquote }}">{{ stop.stop }}</a></li>
                {% endfor %}
            </ul>
            {% else %}
            <p>No stop data</p>
            {% endif %}
        </div>
    </div>
    {% else %}
    <h2>{{ route.inbound_destination }}{% if user.is_superuser %}{% if outbound_timetable.id %} ‚Ä¢ <a style="font-size: 14px;" href="/api-admin/routes/timetableentry/{{ inbound_timetable.id }}/change/">‚úé</a>{% else %} ‚Ä¢ <a style="font-size: 14px;" href="/api-admin/routes/routestop/{{ route_stops_full.inbound.id }}/change/">‚úé</a>{% endif %}{% endif %}</h2>

    <div class="stop-visibility">
        <input type="radio" name="stop-visibility-outbound" id="timing-point-outbound" checked>
        <label for="timing-point-outbound">Timing Points</label>

        <input type="radio" name="stop-visibility-outbound" id="all-stops-outbound">
        <label for="all-stops-outbound">All Stops</label>
    </div><br>

    {% if inbound_timetable.start_date and inbound_timetable.end_date %}
        <p>This timetable runs from, {{ inbound_timetable.start_date }}, until, {{ inbound_timetable.end_date }}</p>
        {% elif inbound_timetable.start_date %}
        <p>This timetable runs from, {{ inbound_timetable.start_date }}</p>
        {% elif inbound_timetable.end_date %}
        <p>This timetable runs until, {{ inbound_timetable.end_date }}</p>
    {% endif %}

    <div class="timetable" id="outbound-timetable">
        {% if inboundStops %}
        <table class="fleet" border="0" cellpadding="10" cellspacing="0">
            <tbody>
                {% if inboundUniqueOperators|length > 1 %}
                <tr class="stop-row">
                    <th class="stop-name operator-name" scope="row">Operator</th>
                    {% for group in inboundGroupedSchedule %}
                    <td style="border-top: 0;" class="stop-operator" colspan="{{ group.colspan }}">{{ group.name }}</td>
                    {% endfor %}
                </tr>
                {% endif %}
                {% for idx, stop in inboundTimetableData.items %}
                <tr id="{{ stop.stopname }}" class="stop-row {% if not stop.timing_point %}minor{% endif %}">
                    <th class="stop-name" scope="row">
                        <a href="/stop/?name={{ idx|urlquote }}">{{ stop.stopname }}</a>
                    </th>
                    {% for time in stop.times %}
                    <td class="stop-time col-{{ forloop.counter0 }}">
                        {{ time }}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% elif route_stops_full.inbound %}
        <ul class="route">
            {% for stop in route_stops_full.inbound.stops %}
            <li {% if not stop.timing_point %}class="minor" {% endif %}><a
                    href="/stop/?name={{ stop.stop|urlquote }}">{{ stop.stop }}</a></li>
            {% endfor %}
        </ul>
        {% else %}
        <p>No trips today</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    async function getTrackingCount() {
        console.log("Getting tracking count...");
       
        let routeId = "{{ route.id }}";
        const url = `/api/trips/simulated_positions/?ymax=85.05112900000006&ymin=-85.05112900000005&xmax=262.85594133583794&xmin=-211.1379366828278&route_id=${routeId}&limit=1`;
        
        const res = await fetch(url);

        console.log("Fetched URL:", url);

        const data = await res.json();

        const count = data.count || 0;

        const mapBT = document.getElementById('mapBT');
        if (count > 0) {
            mapBT.textContent = `Map (tracking ${count} vehicle${count !== 1 ? 's' : ''})`;
        } else {
            mapBT.textContent = 'Map';
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        getTrackingCount();
        const hash = window.location.hash.substring(1); // remove the '#'
        if (!hash) return;

        // Find the header cell with the matching id
        const targetCell = document.getElementById(hash);
        if (!targetCell) return;

        // Get its parent row and index
        const cellIndex = Array.from(targetCell.parentElement.children).indexOf(targetCell);
        if (cellIndex === -1) return;

        // Loop through all rows and highlight the same column
        document.querySelectorAll(".timetable tr").forEach(row => {
            const cell = row.children[cellIndex];
            if (cell && cell.tagName.toLowerCase() === 'td' && !cell.classList.contains(
                    'stop-operator')) {
                cell.classList.add("highlight-col");
            }
        });
    });
</script>

{% if route.related_route.all %}
{% if route.related_route.count > 0 %}
<h2>Related Routes</h2>
<ul>
    {% for rel_route in route.related_route.all %}
    <li>
        <p>
            <a href="/operator/{{ rel_route.route_operators.first.operator_slug|urlencode }}/route/{{ rel_route.id }}">
                <strong class="name routeName">{{ rel_route.route_num }}</strong>
                <span class="description">{{ rel_route.inbound_destination }}{% if rel_route.outbound_destination %} -
                    {{ rel_route.outbound_destination }}{% endif %}</span>
            </a>
            <small style="margin-top: 2.5px;">{{ rel_route.route_operators.first.operator_name }}</small>
        </p>
    </li>
    {% endfor %}
</ul>
{% endif %}
{% endif %}

<div class="in-page-ad" id="body-ad-1">
  <div class="incontent-ad-container" style="height:100px;">
    <div id="AFM_inContent_ad" style="margin:auto;"></div>
  </div>
</div>

<div class="operator_info">
    <h2>{{ operator.operator_name }}</h2>
    <dl class="contact-details">
        {% if operator.operator_details.website %}
        <div>
            <dt>Website</dt>
            <dd><a href="{{ operator.operator_details.website }}"
                    target="_blank">{{ operator.operator_details.website }}</a></dd>
        </div>
        {% endif %}
        {% if operator.operator_details.twitter %}
        <div>
            <dt>Twitter</dt>
            <dd>{{ operator.operator_details.twitter }}</dd>
        </div>
        {% endif %}
        {% if operator.operator_details.game %}
        <div>
            <dt>Game</dt>
            <dd><a href="/game/{{ operator.operator_details.game }}">{{ operator.operator_details.game }}</a></dd>
        </div>
        {% endif %}
        {% if operator.operator_details.type %}
        <div>
            <dt>Type</dt>
            <dd>{{ operator.operator_details.type }}</dd>
        </div>
        {% endif %}
        {% if operator.operator_details.transit_authorities %}
        <div>
            <dt>Authorities</dt>
            <dd>{{ operator.operator_details.transit_authorities }}</dd>
        </div>
        {% endif %}
        {% if route.route_depot %}
        <div>
            <dt>Depot</dt>
            <dd>{{ route.route_depot }}</dd>
        </div>
        {% endif %}
    </dl>
</div>
<script>
    function printTable() {
        const printable = document.getElementById('printable-area').innerHTML;
        const original = document.body.innerHTML;

        document.body.innerHTML = `
      <html>
      <head>
        <title>Print Fleet Table</title>
        <style>
          @media print {
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              zoom: 80%; /* Shrinks content to fit horizontally */
            }
            table {
              border-collapse: collapse;
              width: 100%;
            }
            th, td {
              border: 1px solid #ccc;
              padding: 6px;
              font-size: 10px;
            }
            .livery-cell {
              width: 20px;
              height: 20px;
              display: inline-block;
              margin-right: 5px;
              vertical-align: middle;
            }

            /* Landscape orientation for wide tables */
            @page {
              size: A4 landscape;
              margin: 10mm;
            }
          }
        </style>
      </head>
      <body>
        ${printable}
      </body>
      </html>
    `;

        window.print();
        document.body.innerHTML = original;
        location.reload(); // Restore page
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const timingRadio = document.getElementById('timing-point-outbound');
        const allStopsRadio = document.getElementById('all-stops-outbound');

        // Only select `.minor` elements within #outbound-timetable
        const timetable = document.getElementById('outbound-timetable');
        const minorStops = timetable.querySelectorAll('.minor');

        function updateVisibility() {
            if (timingRadio.checked) {
                minorStops.forEach(el => el.style.display = 'none');
            } else {
                minorStops.forEach(el => el.style.display = '');
            }
        }

        timingRadio.addEventListener('change', updateVisibility);
        allStopsRadio.addEventListener('change', updateVisibility);

        // Initial visibility
        updateVisibility();
    });

    document.addEventListener('DOMContentLoaded', function () {
        const timingRadio = document.getElementById('timing-point-inbound');
        const allStopsRadio = document.getElementById('all-stops-inbound');

        // Only select `.minor` elements within #inbound-timetable
        const timetable = document.getElementById('inbound-timetable');
        const minorStops = timetable.querySelectorAll('.minor');

        function updateVisibility() {
            if (timingRadio.checked) {
                minorStops.forEach(el => el.style.display = 'none');
            } else {
                minorStops.forEach(el => el.style.display = '');
            }
        }

        timingRadio.addEventListener('change', updateVisibility);
        allStopsRadio.addEventListener('change', updateVisibility);

        // Initial visibility
        updateVisibility();
    });
</script>



{% endblock %}