{% extends 'mbtbase.html' %}
{% load static %}
{% load meta_tags %}

{% block extra_meta %}
    {% meta_description "{{ operator.operator_name }} - Route list" %}
    {% meta_keywords "routes, route, route list, {{ operator.operator_name }}" %}
    {% meta_title "{{ operator.operator_name }} - Route List" %}
    {% meta_url "https://www.mybustimes.cc/operator/{{ operator.operator_slug }}/" %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/narrow.css' %}">
<style>
    .status-card {
        border: 1px solid var(--border-color);
        padding: 15px;
        border-radius: 6px;
        background: var(--background-color);
        margin-bottom: 15px;
        color: var(--text-color);
    }

    .status-card h2,
    .status-card h3 {
        margin-top: 0;
        color: var(--text-color);
    }

    .status-pill {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 12px;
        color: #fff;
    }

    .pill-ok { background: #2ecc71; }
    .pill-warn { background: #f1c40f; }
    .pill-bad { background: #e74c3c; }
    .pill-info { background: #3498db; }
    .pill-neutral { background: #95a5a6; }

    .status-warning {
        border: 1px solid var(--brand-color);
        background: var(--brand-color-darker);
        padding: 10px;
        border-radius: 4px;
        color: var(--text-color);
        margin-bottom: 15px;
    }

    /* Table layout */
    .status-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: var(--background-color);
        color: var(--text-color);
        border: 1px solid var(--border-color-darker);
        border-radius: 6px;
        overflow: hidden;
    }

    .status-table th,
    .status-table td {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border-color);
        text-align: left;
    }

    .status-table th {
        background: var(--brand-color-darker);
        color: #fff;
        font-weight: bold;
    }

    .status-table tr:last-child td {
        border-bottom: none;
    }

    .yes-cell { color: #2ecc71; font-weight: bold; }
    .no-cell { color: #e74c3c; font-weight: bold; }
</style>

{% endblock %}

{% block title %}{{ operator.operator_name }}{% endblock %}

{% block content %}
<script>
    window.statusReport = {{ status_report_json|safe }};
</script>
<br>
<div id="statusBox"></div>

<script>
const status = window.statusReport;

function pill(text, cls) {
    return `<span class="status-pill ${cls}">${text}</span>`;
}

function yesNo(val) {
    return val
        ? `<span class="yes-cell">Yes</span>`
        : `<span class="no-cell">No</span>`;
}

function renderStatus(status) {
    const isCircular = status.is_circular === true;

    function statusClass(state) {
        if (state === "Ok") return "pill-ok";
        if (state === "Missing Stops") return "pill-warn";
        if (state === "Stops without Coordinates") return "pill-warn";
        if (state === "No Timetable") return "pill-bad";
        return "pill-neutral";
    }

    const missingOutbound =
        !status.all.outbound.has_timetable &&
        !status.all.outbound.has_stops;

    // SUMMARY CARD
    let html = `
        <div class="status-card">
            <h2>Route Status Summary</h2>

            <p><strong>Inbound:</strong>
                ${pill(status.inbound, statusClass(status.inbound))}
            </p>

            <p><strong>Outbound:</strong>
                ${isCircular 
                    ? pill("Circular Route - No Outbound", "pill-info")
                    : pill(status.outbound, statusClass(status.outbound))
                }
            </p>

            <p><strong>Overall:</strong>
                ${pill(status.overall, statusClass(status.overall))}
            </p>
        </div>
    `;

    // WARNING
    if (!isCircular && missingOutbound) {
        html += `
            <div class="status-warning">
                <strong>Warning:</strong> This route is missing all outbound timetable and stop data.
            </div>
        `;
    }

    console.log(status);

    // TABLES
    html += `
        <div class="status-card">
            <h3>Inbound Data</h3>
            <table class="status-table">
                <tr><th>Has Timetable</th><td>${yesNo(status.all.inbound.has_timetable)}</td></tr>
                <tr><th>Has Stops</th><td>${yesNo(status.all.inbound.has_stops)}</td></tr>
                <tr><th>Has Stops Coordinates</th><td>${yesNo(status.all.inbound.has_stop_coords)}</td></tr>
                <tr><th>Fully Valid</th><td>${yesNo(status.all.overall.inbound)}</td></tr>
            </table>
        </div>

        <div class="status-card">
            <h3>Outbound Data</h3>
            <table class="status-table">
                <tr><th>Has Timetable</th><td>${yesNo(status.all.outbound.has_timetable)}</td></tr>
                <tr><th>Has Stops</th><td>${yesNo(status.all.outbound.has_stops)}</td></tr>
                <tr><th>Has Stops Coordinates</th><td>${yesNo(status.all.outbound.has_stop_coords)}</td></tr>
                <tr><th>Fully Valid</th><td>${yesNo(status.all.overall.outbound)}</td></tr>
            </table>
        </div>
    `;

    document.getElementById("statusBox").innerHTML = html;
}

renderStatus(status);
</script>

{% endblock %}

